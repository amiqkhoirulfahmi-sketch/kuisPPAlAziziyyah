<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz PP Al Aziziyyah - Kuis Interaktif</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', 'Segoe UI', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            background-image: linear-gradient(to bottom, #f0f7ff, #ffffff);
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            max-width: 1200px;
            width: 90%;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #0a3d62 0%, #1e5799 100%);
            padding: 15px 0;
            box-shadow: 0 4px 15px rgba(10, 61, 98, 0.2);
            border-radius: 0 0 20px 20px;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            background-color: #ffcc00;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #0a3d62;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .logo-text {
            display: flex;
            flex-direction: column;
        }
        
        .logo-text h1 {
            font-family: 'Amiri', serif;
            font-size: 2.2rem;
            font-weight: 700;
            color: #fff;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
            line-height: 1.1;
        }
        
        .logo-text .subtitle {
            font-size: 1rem;
            color: #a3d5ff;
            font-weight: 400;
            letter-spacing: 1px;
            margin-top: 5px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: rgba(255, 255, 255, 0.15);
            padding: 10px 20px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .user-info i {
            color: #ffcc00;
        }
        
        .user-info span {
            font-weight: 500;
            color: white;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            margin-left: 10px;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 25px;
            flex-grow: 1;
        }
        
        .screen {
            background-color: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(10, 61, 98, 0.08);
            border: 1px solid #e6f0fa;
            display: none;
        }
        
        .screen.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .screen-title {
            text-align: center;
            margin-bottom: 25px;
            color: #0a3d62;
            font-size: 2rem;
            font-weight: 700;
            position: relative;
            padding-bottom: 15px;
        }
        
        .screen-title::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: linear-gradient(to right, #0a3d62, #3c8dbc);
            border-radius: 2px;
        }
        
        /* Login Screen */
        .login-container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .login-form {
            background-color: #f8fbff;
            padding: 30px;
            border-radius: 15px;
            border: 1px solid #e6f0fa;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #0a3d62;
        }
        
        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid #e6f0fa;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #3c8dbc;
            box-shadow: 0 0 0 3px rgba(60, 141, 188, 0.1);
        }
        
        .role-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .role-option {
            flex: 1;
            text-align: center;
            padding: 20px;
            border: 2px solid #e6f0fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .role-option:hover {
            border-color: #3c8dbc;
            background-color: #f8fbff;
        }
        
        .role-option.active {
            border-color: #0a3d62;
            background-color: #e6f0fa;
        }
        
        .role-option i {
            font-size: 2rem;
            color: #0a3d62;
            margin-bottom: 10px;
        }
        
        /* Santri Answer Screen */
        .santri-answer-container {
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }
        
        .santri-question {
            font-size: 1.8rem;
            margin-bottom: 30px;
            color: #0a3d62;
        }
        
        .answer-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .santri-answer-option {
            padding: 20px;
            border: 2px solid #e6f0fa;
            border-radius: 10px;
            background: white;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 20px;
        }
        
        .santri-answer-option:hover {
            border-color: #3c8dbc;
            transform: translateY(-3px);
        }
        
        .santri-answer-option.selected {
            border-color: #0a3d62;
            background-color: #e6f0fa;
        }
        
        .santri-answer-option.correct {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-color: #28a745;
            color: #155724;
        }
        
        .santri-answer-option.incorrect {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border-color: #dc3545;
            color: #721c24;
        }
        
        /* Create Quiz Screen */
        .quiz-form-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .quiz-form {
            background-color: #f8fbff;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #e6f0fa;
        }
        
        .question-item {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 1px solid #e6f0fa;
            position: relative;
        }
        
        .question-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .remove-question {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .add-question-btn {
            width: 100%;
            padding: 15px;
            background: #e6f0fa;
            border: 2px dashed #c1dbf2;
            border-radius: 10px;
            font-size: 1.1rem;
            color: #0a3d62;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
        }
        
        .add-question-btn:hover {
            background: #d1e5f5;
            border-color: #3c8dbc;
        }
        
        .answer-option-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .correct-answer-checkbox {
            width: 20px;
            height: 20px;
        }
        
        /* Manage Quizzes Screen */
        .quizzes-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .quiz-card {
            background: linear-gradient(135deg, #f8fbff 0%, #e6f0fa 100%);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #d1e5f5;
            transition: all 0.3s;
        }
        
        .quiz-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(10, 61, 98, 0.1);
        }
        
        .quiz-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .quiz-card-title {
            font-size: 1.5rem;
            color: #0a3d62;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .quiz-card-pin {
            background-color: #0a3d62;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .quiz-card-info {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            color: #666;
            font-size: 0.9rem;
        }
        
        .quiz-card-info span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .quiz-card-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .action-btn-primary {
            background: linear-gradient(135deg, #0a3d62 0%, #3c8dbc 100%);
            color: white;
        }
        
        .action-btn-warning {
            background: linear-gradient(135deg, #ffcc00 0%, #ff9900 100%);
            color: #0a3d62;
        }
        
        .action-btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff416c 100%);
            color: white;
        }
        
        .action-btn-outline {
            background: white;
            color: #0a3d62;
            border: 2px solid #0a3d62;
        }
        
        /* Quiz Results Screen */
        .results-container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .quiz-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background-color: #f8fbff;
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #e6f0fa;
        }
        
        .quiz-results-info {
            display: flex;
            gap: 30px;
        }
        
        .result-stat {
            text-align: center;
        }
        
        .result-stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: #0a3d62;
        }
        
        .result-stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .results-table-container {
            background-color: white;
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #e6f0fa;
            margin-top: 20px;
            overflow-x: auto;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .results-table th {
            background-color: #f8fbff;
            color: #0a3d62;
            padding: 15px;
            text-align: left;
            border-bottom: 2px solid #e6f0fa;
            font-weight: 700;
        }
        
        .results-table td {
            padding: 15px;
            border-bottom: 1px solid #e6f0fa;
        }
        
        .results-table tr:hover {
            background-color: #f8fbff;
        }
        
        .player-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .rank-badge {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e6f0fa;
            color: #0a3d62;
            text-align: center;
            line-height: 30px;
            font-weight: 700;
            margin-right: 10px;
        }
        
        .rank-1-badge {
            background-color: #ffcc00;
            color: #0a3d62;
        }
        
        .rank-2-badge {
            background-color: #c1dbf2;
            color: #0a3d62;
        }
        
        .rank-3-badge {
            background-color: #a3d5ff;
            color: #0a3d62;
        }
        
        .score-cell {
            font-weight: 700;
            color: #0a3d62;
            font-size: 1.2rem;
        }
        
        .percentage-cell {
            font-weight: 600;
            color: #28a745;
        }
        
        /* Winner Section */
        .winner {
            text-align: center;
            background: linear-gradient(135deg, #0a3d62 0%, #3c8dbc 100%);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            color: white;
            box-shadow: 0 10px 30px rgba(10, 61, 98, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .winner::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        
        .winner h2 {
            font-size: 2.2rem;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }
        
        .winner-name {
            font-size: 3rem;
            font-weight: 800;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1;
            color: #ffcc00;
            font-family: 'Amiri', serif;
        }
        
        .scoreboard {
            background-color: #f8fbff;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            border: 1px solid #e6f0fa;
        }
        
        .scoreboard h3 {
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.8rem;
            color: #0a3d62;
            position: relative;
            padding-bottom: 10px;
        }
        
        .scoreboard h3::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background: linear-gradient(to right, #0a3d62, #3c8dbc);
            border-radius: 2px;
        }
        
        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 20px;
            background-color: white;
            border-radius: 12px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            border: 1px solid #e6f0fa;
        }
        
        .score-item:hover {
            transform: translateX(10px);
            box-shadow: 0 5px 15px rgba(10, 61, 98, 0.1);
        }
        
        .player-rank {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .rank {
            font-size: 1.5rem;
            font-weight: 800;
            color: #0a3d62;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e6f0fa;
            border-radius: 50%;
        }
        
        .rank-1 {
            background-color: #ffcc00;
            color: #0a3d62;
        }
        
        .rank-2 {
            background-color: #c1dbf2;
            color: #0a3d62;
        }
        
        .rank-3 {
            background-color: #a3d5ff;
            color: #0a3d62;
        }
        
        .player-score {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0a3d62;
        }
        
        /* Controls */
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.1);
        }
        
        .btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0a3d62 0%, #3c8dbc 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffcc00 0%, #ff9900 100%);
            color: #0a3d62;
        }
        
        .btn-outline {
            background: white;
            color: #0a3d62;
            border: 2px solid #0a3d62;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #e6f0fa;
        }
        
        .hidden {
            display: none;
        }
        
        .points-badge {
            position: absolute;
            right: 20px;
            background-color: #ffcc00;
            color: #0a3d62;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
            animation: popIn 0.5s ease;
        }
        
        @keyframes popIn {
            0% { transform: scale(0); }
            80% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .info-text {
            text-align: center;
            color: #666;
            font-size: 1.1rem;
            margin-top: 10px;
            line-height: 1.5;
        }
        
        .arabic-text {
            font-family: 'Amiri', serif;
            font-size: 1.3rem;
            color: #0a3d62;
            font-weight: 700;
        }
        
        .question-category {
            display: inline-block;
            background-color: #e6f0fa;
            color: #0a3d62;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        /* Dashboard */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .dashboard-card {
            background: linear-gradient(135deg, #f8fbff 0%, #e6f0fa 100%);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid #d1e5f5;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .dashboard-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(10, 61, 98, 0.1);
        }
        
        .dashboard-card i {
            font-size: 3.5rem;
            color: #0a3d62;
            margin-bottom: 20px;
        }
        
        .dashboard-card h3 {
            font-size: 1.8rem;
            color: #0a3d62;
            margin-bottom: 15px;
        }
        
        /* Santri Join Screen */
        .join-container {
            max-width: 500px;
            margin: 0 auto;
            text-align: center;
        }
        
        .join-form {
            background-color: #f8fbff;
            padding: 30px;
            border-radius: 15px;
            border: 1px solid #e6f0fa;
        }
        
        .santri-waiting {
            text-align: center;
            padding: 40px;
        }
        
        .loading-spinner {
            font-size: 3rem;
            color: #0a3d62;
            margin-bottom: 20px;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 30px;
            background-color: #f8fbff;
            border-radius: 15px;
            border: 2px dashed #c1dbf2;
        }
        
        .empty-state i {
            font-size: 4rem;
            color: #c1dbf2;
            margin-bottom: 20px;
        }
        
        .empty-state h3 {
            font-size: 1.8rem;
            color: #0a3d62;
            margin-bottom: 15px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e6f0fa;
            padding-bottom: 10px;
        }
        
        .tab {
            padding: 12px 25px;
            background-color: #f8fbff;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #0a3d62 0%, #3c8dbc 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Edit Quiz Screen */
        .edit-quiz-form-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* Timer for Santri */
        .santri-timer-container {
            margin: 20px 0;
        }
        
        .santri-timer {
            font-size: 2rem;
            font-weight: 800;
            color: white;
            background: linear-gradient(135deg, #0a3d62 0%, #3c8dbc 100%);
            padding: 15px 30px;
            border-radius: 50px;
            display: inline-block;
            min-width: 120px;
            box-shadow: 0 5px 15px rgba(10, 61, 98, 0.2);
        }
        
        .santri-timer.warning {
            background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
        }
        
        .santri-timer.danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }
        
        /* Question status for Santri */
        .question-status {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        .question-status-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: #e6f0fa;
        }
        
        .question-status-dot.answered {
            background-color: #4caf50;
        }
        
        .question-status-dot.current {
            background-color: #2196f3;
        }
        
        /* Quiz Status */
        .quiz-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .active-status {
            background-color: #d4edda;
            color: #155724;
        }
        
        .draft-status {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .finished-status {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        /* Quiz Control Panel */
        .quiz-control-panel {
            background-color: #f8fbff;
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #e6f0fa;
            margin-bottom: 30px;
        }
        
        .control-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .control-panel-stats {
            display: flex;
            gap: 30px;
        }
        
        .control-stat {
            text-align: center;
        }
        
        .control-stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: #0a3d62;
        }
        
        .control-stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        /* Santri Answer Feedback */
        .answer-feedback {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        .answer-feedback.correct {
            background-color: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .answer-feedback.incorrect {
            background-color: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        /* Lobby Screen */
        .pin-container {
            text-align: center;
            margin: 25px 0;
        }
        
        .pin-label {
            font-size: 1.2rem;
            color: #555;
            margin-bottom: 10px;
        }
        
        .pin-code {
            font-size: 4rem;
            font-weight: 800;
            letter-spacing: 10px;
            color: #0a3d62;
            background: linear-gradient(to right, #0a3d62, #3c8dbc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            padding: 20px 40px;
            border-radius: 15px;
            display: inline-block;
            margin: 15px 0;
            border: 3px dashed #c1dbf2;
            font-family: 'Courier New', monospace;
        }
        
        .players-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .player {
            background: linear-gradient(135deg, #e6f0fa 0%, #c1dbf2 100%);
            padding: 15px 25px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #d1e5f5;
            transition: all 0.3s ease;
        }
        
        .player i {
            color: #0a3d62;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .notification.warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }
    </style>
</head>
<body>
    <header id="app-header" class="hidden">
        <div class="container">
            <div class="header-content">
                <div class="logo-container">
                    <div class="logo-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="logo-text">
                        <h1>Quiz PP Al Aziziyyah</h1>
                        <div class="subtitle" id="user-role-subtitle">Pondok Pesantren Al Aziziyyah</div>
                    </div>
                </div>
                <div class="user-info" id="user-info">
                    </div>
            </div>
        </div>
    </header>
    
    <div class="container main-content">
        <div id="login-screen" class="screen active">
            <h2 class="screen-title">Selamat Datang</h2>
            <p class="info-text">Silakan login sebagai Ustadz atau Santri</p>
            
            <div class="login-container">
                <div class="role-selector">
                    <div class="role-option active" data-role="ustadz">
                        <i class="fas fa-user-tie"></i>
                        <h3>Ustadz</h3>
                        <p>Membuat dan mengelola kuis</p>
                    </div>
                    <div class="role-option" data-role="santri">
                        <i class="fas fa-user-graduate"></i>
                        <h3>Santri</h3>
                        <p>Mengikuti kuis yang tersedia</p>
                    </div>
                </div>
                
                <div class="login-form">
                    <div class="form-group">
                        <label for="username">Nama Pengguna</label>
                        <input type="text" id="username" class="form-control" placeholder="Masukkan nama pengguna">
                    </div>
                    <div class="form-group">
                        <label for="password">Kata Sandi</label>
                        <input type="password" id="password" class="form-control" placeholder="Masukkan kata sandi">
                    </div>
                    <div class="controls">
                        <button id="login-btn" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt"></i> Masuk
                        </button>
                    </div>
                    <p class="info-text" style="margin-top: 20px;">
                        <strong>Demo Account:</strong><br>
                        Ustadz: usernya: ustadz, sandi: 123<br>
                        Santri: usernya: santri, sandi: 123
                    </p>
                </div>
            </div>
        </div>
        
        <div id="ustadz-dashboard" class="screen">
            <h2 class="screen-title">Dashboard Ustadz</h2>
            <p class="info-text">Selamat datang, <span id="ustadz-name"></span></p>
            
            <div class="dashboard-cards">
                <div class="dashboard-card" id="create-quiz-card">
                    <i class="fas fa-plus-circle"></i>
                    <h3>Buat Kuis Baru</h3>
                    <p>Buat kuis baru dengan soal-soal custom</p>
                </div>
                <div class="dashboard-card" id="manage-quiz-card">
                    <i class="fas fa-list-alt"></i>
                    <h3>Kelola Kuis</h3>
                    <p>Lihat dan kelola kuis yang telah dibuat</p>
                </div>
                <div class="dashboard-card" id="start-quiz-card">
                    <i class="fas fa-play-circle"></i>
                    <h3>Mulai Kuis</h3>
                    <p>Mulai kuis yang sudah dipersiapkan</p>
                </div>
                <div class="dashboard-card" id="view-results-card">
                    <i class="fas fa-chart-bar"></i>
                    <h3>Hasil Kuis</h3>
                    <p>Lihat hasil kuis yang telah berlangsung</p>
                </div>
            </div>
        </div>
        
        <div id="santri-dashboard" class="screen">
            <h2 class="screen-title">Dashboard Santri</h2>
            <p class="info-text">Selamat datang, <span id="santri-name"></span></p>
            
            <div class="dashboard-cards">
                <div class="dashboard-card" id="join-quiz-card">
                    <i class="fas fa-sign-in-alt"></i>
                    <h3>Bergabung Kuis</h3>
                    <p>Bergabung dengan kuis menggunakan PIN</p>
                </div>
                <div class="dashboard-card" id="santri-results-card">
                    <i class="fas fa-trophy"></i>
                    <h3>Hasil Saya</h3>
                    <p>Lihat hasil kuis yang pernah diikuti</p>
                </div>
            </div>
        </div>
        
        <div id="create-quiz-screen" class="screen">
            <h2 class="screen-title">Buat Kuis Baru</h2>
            
            <div class="quiz-form-container">
                <div class="quiz-form">
                    <div class="form-group">
                        <label for="quiz-title">Judul Kuis</label>
                        <input type="text" id="quiz-title" class="form-control" placeholder="Masukkan judul kuis">
                    </div>
                    
                    <div id="questions-container">
                        </div>
                    
                    <button id="add-question-btn" class="add-question-btn">
                        <i class="fas fa-plus"></i> Tambah Pertanyaan
                    </button>
                    
                    <div class="controls" style="margin-top: 30px;">
                        <button id="save-quiz-btn" class="btn btn-success">
                            <i class="fas fa-save"></i> Simpan Kuis
                        </button>
                        <button id="cancel-create-quiz-btn" class="btn btn-outline">
                            <i class="fas fa-times"></i> Batal
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="edit-quiz-screen" class="screen">
            <h2 class="screen-title">Edit Kuis</h2>
            
            <div class="edit-quiz-form-container">
                <div class="quiz-form">
                    <div class="form-group">
                        <label for="edit-quiz-title">Judul Kuis</label>
                        <input type="text" id="edit-quiz-title" class="form-control" placeholder="Masukkan judul kuis">
                    </div>
                    
                    <div id="edit-questions-container">
                        </div>
                    
                    <button id="add-question-edit-btn" class="add-question-btn">
                        <i class="fas fa-plus"></i> Tambah Pertanyaan
                    </button>
                    
                    <div class="controls" style="margin-top: 30px;">
                        <button id="update-quiz-btn" class="btn btn-success">
                            <i class="fas fa-save"></i> Perbarui Kuis
                        </button>
                        <button id="cancel-edit-quiz-btn" class="btn btn-outline">
                            <i class="fas fa-times"></i> Batal
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="manage-quizzes-screen" class="screen">
            <h2 class="screen-title">Kelola Kuis</h2>
            
            <div class="tabs">
                <button class="tab active" data-tab="all-quizzes">Semua Kuis</button>
                <button class="tab" data-tab="draft-quizzes">Draft</button>
                <button class="tab" data-tab="active-quizzes">Aktif</button>
            </div>
            
            <div class="tab-content active" id="all-quizzes-tab">
                <div id="quizzes-list-container">
                    </div>
            </div>
            
            <div class="tab-content" id="draft-quizzes-tab">
                <div id="draft-quizzes-container">
                    </div>
            </div>
            
            <div class="tab-content" id="active-quizzes-tab">
                <div id="active-quizzes-container">
                    </div>
            </div>
            
            <div class="controls">
                <button id="back-to-dashboard-from-manage-btn" class="btn btn-outline">
                    <i class="fas fa-arrow-left"></i> Kembali ke Dashboard
                </button>
            </div>
        </div>
        
        <div id="quiz-control-panel" class="screen">
            <div class="quiz-control-panel">
                <div class="control-panel-header">
                    <div>
                        <h2 id="control-quiz-title">Nama Kuis</h2>
                        <p>PIN: <strong id="control-quiz-pin"></strong></p>
                    </div>
                    <div class="control-panel-stats">
                        <div class="control-stat">
                            <div class="control-stat-value" id="control-player-count">0</div>
                            <div class="control-stat-label">Peserta</div>
                        </div>
                        <div class="control-stat">
                            <div class="control-stat-value" id="control-question-number">0/0</div>
                            <div class="control-stat-label">Pertanyaan</div>
                        </div>
                    </div>
                </div>
                
                <div class="question-container">
                    <div class="question-number" id="control-question-number-text">Pertanyaan 0 dari 0</div>
                    <div class="question-text" id="control-question-text">Tidak ada pertanyaan.</div>
                </div>
                
                <div class="players-list" id="control-players-list">
                    </div>
                
                <div class="controls">
                    <button id="control-next-question-btn" class="btn btn-primary">
                        <i class="fas fa-forward"></i> Pertanyaan Berikutnya
                    </button>
                    <button id="control-end-quiz-btn" class="btn btn-warning">
                        <i class="fas fa-stop"></i> Akhiri Kuis
                    </button>
                    <button id="control-back-to-dashboard-btn" class="btn btn-outline">
                        <i class="fas fa-home"></i> Kembali ke Dashboard
                    </button>
                </div>
            </div>
        </div>
        
        <div id="quiz-results-dashboard" class="screen">
            <h2 class="screen-title">Hasil Kuis</h2>
            
            <div class="tabs">
                <button class="tab active" data-tab="recent-results">Hasil Terbaru</button>
                <button class="tab" data-tab="all-results">Semua Hasil</button>
                <button class="tab" data-tab="top-performers">Santri Terbaik</button>
            </div>
            
            <div class="tab-content active" id="recent-results-tab">
                <div id="recent-results-container">
                    </div>
            </div>
            
            <div class="tab-content" id="all-results-tab">
                <div id="all-results-container">
                    </div>
            </div>
            
            <div class="tab-content" id="top-performers-tab">
                <div id="top-performers-container">
                    </div>
            </div>
            
            <div class="controls">
                <button id="back-to-dashboard-from-results-btn" class="btn btn-outline">
                    <i class="fas fa-arrow-left"></i> Kembali ke Dashboard
                </button>
            </div>
        </div>
        
        <div id="detail-results-screen" class="screen">
            <div class="results-container">
                <div id="detail-results-content">
                    </div>
                
                <div class="controls">
                    <button id="back-to-results-dashboard-btn" class="btn btn-outline">
                        <i class="fas fa-arrow-left"></i> Kembali ke Hasil Kuis
                    </button>
                </div>
            </div>
        </div>
        
        <div id="santri-join-screen" class="screen">
            <h2 class="screen-title">Bergabung Kuis</h2>
            
            <div class="join-container">
                <div class="join-form">
                    <div class="form-group">
                        <label for="quiz-pin">Kode PIN Kuis</label>
                        <input type="text" id="quiz-pin" class="form-control" placeholder="Masukkan kode PIN kuis" maxlength="4">
                    </div>
                    <div class="form-group">
                        <label for="santri-display-name">Nama Tampilan</label>
                        <input type="text" id="santri-display-name" class="form-control" placeholder="Masukkan nama tampilan Anda" value="Santri">
                    </div>
                    <div class="controls">
                        <button id="join-quiz-btn" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt"></i> Bergabung
                        </button>
                        <button id="cancel-join-btn" class="btn btn-outline">
                            <i class="fas fa-times"></i> Batal
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="santri-waiting-screen" class="screen">
            <div class="santri-waiting">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <h2>Menunggu Kuis Dimulai</h2>
                <p class="info-text">Anda telah bergabung dalam kuis. Silakan tunggu hingga ustadz memulai kuis.</p>
                <p class="info-text">Kode PIN: <strong id="waiting-pin"></strong></p>
                <p class="info-text">Nama Anda: <strong id="waiting-name"></strong></p>
                <div class="controls">
                    <button id="leave-quiz-btn" class="btn btn-outline">
                        <i class="fas fa-sign-out-alt"></i> Keluar Kuis
                    </button>
                </div>
            </div>
        </div>
        
        <div id="santri-answer-screen" class="screen">
            <div class="santri-answer-container">
                <div class="question-number" id="santri-question-number">Pertanyaan 1 dari 5</div>
                <div class="santri-question" id="santri-question-text">Berapakah jumlah Rukun Islam?</div>
                
                <div class="santri-timer-container">
                    <div class="santri-timer" id="santri-timer">15</div>
                </div>
                
                <div class="question-status" id="santri-question-status">
                    </div>
                
                <div class="answer-options" id="santri-answer-options">
                    </div>
                
                <div id="santri-answer-feedback" class="answer-feedback hidden">
                    </div>
                
                <div class="controls">
                    <button id="submit-answer-btn" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Kirim Jawaban
                    </button>
                </div>
            </div>
        </div>
        
        <div id="lobby-screen" class="screen">
            <h2 class="screen-title">Ruang Tunggu Kuis</h2>
            <p class="info-text">Berikan kode PIN berikut kepada santri untuk bergabung dalam kuis interaktif</p>
            
            <div class="pin-container">
                <div class="pin-label">Kode PIN Kuis:</div>
                <div class="pin-code" id="pin-code"></div>
                <p class="info-text">Santri yang bergabung akan muncul di bawah ini</p>
            </div>
            
            <div class="players-list" id="players-list">
                </div>
            
            <div class="controls">
                <button id="start-quiz-from-lobby-btn" class="btn btn-primary">
                    <i class="fas fa-play-circle"></i> Mulai Kuis
                </button>
                <button id="back-to-dashboard-btn" class="btn btn-outline">
                    <i class="fas fa-arrow-left"></i> Kembali
                </button>
            </div>
        </div>
        
        <div id="results-screen" class="screen">
            <div class="results-container">
                <div class="winner">
                    <h2>Juara Kuis</h2>
                    <div class="winner-name" id="winner-name"></div>
                    <p style="font-size: 1.5rem; margin-top: 10px; position: relative; z-index: 1;">Skor: <span id="winner-score"></span> poin</p>
                    <p class="arabic-text" style="margin-top: 15px; position: relative; z-index: 1;">  </p>
                </div>
                
                <div class="scoreboard">
                    <h3>Peringkat Santri</h3>
                    <div id="scoreboard-list">
                        </div>
                </div>
                
                <div class="controls">
                    <button id="back-to-dashboard-from-final-results-btn" class="btn btn-warning">
                        <i class="fas fa-home"></i> Kembali ke Dashboard
                    </button>
                    <button id="save-results-btn" class="btn btn-success">
                        <i class="fas fa-save"></i> Simpan Hasil
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="container">
            <p>Quiz PP Al Aziziyyah &copy; 2025 - Aplikasi Kuis Interaktif Pondok Pesantren Al Aziziyyah</p>
            <p>"Menuntut ilmu adalah ibadah" -   </p>
        </div>
    </footer>

    <script>
        // Data aplikasi
        let appData = {
            currentUser: null,
            currentScreen: 'login',
            userRole: null,
            activeQuizzes: {},
            createdQuizzes: [], // Akan dimuat dari localStorage
            quizResults: [],    // Akan dimuat dari localStorage
            currentQuiz: null,
            santriData: {
                joinedQuiz: false,
                currentQuizPin: null,
                displayName: null,
                answerSubmitted: false,
                score: 0,
                answers: []
            },
            editingQuizId: null,
            quizTimer: null,
            quizTimeLeft: 0
        };

        // --- FUNGSI PERSISTENSI DATA BARU ---
        
        // Simpan data kuis ke Local Storage
        function saveData() {
            try {
                localStorage.setItem('createdQuizzes', JSON.stringify(appData.createdQuizzes));
                localStorage.setItem('quizResults', JSON.stringify(appData.quizResults));
                // activeQuizzes TIDAK disimpan karena statusnya hanya berlaku untuk sesi runtime saat ini
            } catch (e) {
                console.error("Error saving to local storage", e);
            }
        }

        // Muat data kuis dari Local Storage
        function loadData() {
            try {
                const loadedQuizzes = localStorage.getItem('createdQuizzes');
                const loadedResults = localStorage.getItem('quizResults');
                
                if (loadedQuizzes) {
                    appData.createdQuizzes = JSON.parse(loadedQuizzes);
                }
                if (loadedResults) {
                    appData.quizResults = JSON.parse(loadedResults);
                }

                // Inisialisasi ulang activeQuizzes dari data yang aktif di createdQuizzes (jika ada)
                appData.activeQuizzes = {};
                appData.createdQuizzes.forEach(quiz => {
                    if (quiz.status === 'active') {
                        appData.activeQuizzes[quiz.pin] = {
                            quiz: quiz,
                            players: [], // Pemain harus kosong saat load
                            currentQuestionIndex: 0,
                            isActive: false,
                            startTime: null
                        };
                    }
                });

            } catch (e) {
                console.error("Error loading from local storage", e);
                // Jika gagal parsing, kembalikan ke array kosong
                appData.createdQuizzes = [];
                appData.quizResults = [];
            }
        }
        
        // --- END FUNGSI PERSISTENSI DATA BARU ---

        // Simulasi WebSocket untuk komunikasi real-time antara ustadz dan santri
        const QuizWebSocket = {
            listeners: {},
            
            // Simulasi pengiriman event
            sendEvent: function(eventType, data) {
                // Update tampilan Ustadz langsung (simulasi real-time)
                if (eventType === 'player-joined' && appData.currentScreen === 'lobby' && appData.userRole === 'ustadz') {
                    updateLobbyPlayersList();
                }

                if (this.listeners[eventType]) {
                    this.listeners[eventType].forEach(callback => {
                        // Simulasi delay singkat untuk event real-time
                        setTimeout(() => callback(data), 100); 
                    });
                }
            },
            
            // Simulasi pendaftaran listener
            addEventListener: function(eventType, callback) {
                if (!this.listeners[eventType]) {
                    this.listeners[eventType] = [];
                }
                this.listeners[eventType].push(callback);
            },
            
            // Simulasi penghapusan listener
            removeEventListener: function(eventType, callback) {
                if (this.listeners[eventType]) {
                    this.listeners[eventType] = this.listeners[eventType].filter(cb => cb !== callback);
                }
            }
        };

        // DOM Elements (Daftar elemen DOM tetap sama)
        const screens = {
            login: document.getElementById('login-screen'),
            ustadzDashboard: document.getElementById('ustadz-dashboard'),
            santriDashboard: document.getElementById('santri-dashboard'),
            createQuiz: document.getElementById('create-quiz-screen'),
            editQuiz: document.getElementById('edit-quiz-screen'),
            manageQuizzes: document.getElementById('manage-quizzes-screen'),
            quizControlPanel: document.getElementById('quiz-control-panel'),
            quizResultsDashboard: document.getElementById('quiz-results-dashboard'),
            detailResults: document.getElementById('detail-results-screen'),
            santriJoin: document.getElementById('santri-join-screen'),
            santriWaiting: document.getElementById('santri-waiting-screen'),
            santriAnswer: document.getElementById('santri-answer-screen'),
            lobby: document.getElementById('lobby-screen'),
            results: document.getElementById('results-screen')
        };

        // Header elements
        const appHeader = document.getElementById('app-header');
        const userInfoElement = document.getElementById('user-info');
        const userRoleSubtitle = document.getElementById('user-role-subtitle');

        // Login elements
        const roleOptions = document.querySelectorAll('.role-option');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');

        // Ustadz dashboard elements
        const ustadzNameElement = document.getElementById('ustadz-name');
        const createQuizCard = document.getElementById('create-quiz-card');
        const manageQuizCard = document.getElementById('manage-quiz-card');
        const startQuizCard = document.getElementById('start-quiz-card');
        const viewResultsCard = document.getElementById('view-results-card');

        // Santri dashboard elements
        const santriNameElement = document.getElementById('santri-name');
        const joinQuizCard = document.getElementById('join-quiz-card');
        const santriResultsCard = document.getElementById('santri-results-card');

        // Create quiz elements
        const questionsContainer = document.getElementById('questions-container');
        const addQuestionBtn = document.getElementById('add-question-btn');
        const saveQuizBtn = document.getElementById('save-quiz-btn');
        const cancelCreateQuizBtn = document.getElementById('cancel-create-quiz-btn');
        const quizTitleInput = document.getElementById('quiz-title');

        // Edit quiz elements
        const editQuestionsContainer = document.getElementById('edit-questions-container');
        const addQuestionEditBtn = document.getElementById('add-question-edit-btn');
        const updateQuizBtn = document.getElementById('update-quiz-btn');
        const cancelEditQuizBtn = document.getElementById('cancel-edit-quiz-btn');
        const editQuizTitleInput = document.getElementById('edit-quiz-title');

        // Manage quizzes elements
        const quizzesListContainer = document.getElementById('quizzes-list-container');
        const draftQuizzesContainer = document.getElementById('draft-quizzes-container');
        const activeQuizzesContainer = document.getElementById('active-quizzes-container');
        const backToDashboardFromManageBtn = document.getElementById('back-to-dashboard-from-manage-btn');
        const tabs = document.querySelectorAll('.tab');

        // Quiz control panel elements
        const controlQuizTitle = document.getElementById('control-quiz-title');
        const controlQuizPin = document.getElementById('control-quiz-pin');
        const controlPlayerCount = document.getElementById('control-player-count');
        const controlQuestionNumber = document.getElementById('control-question-number');
        const controlQuestionNumberText = document.getElementById('control-question-number-text');
        const controlQuestionText = document.getElementById('control-question-text');
        const controlPlayersList = document.getElementById('control-players-list');
        const controlNextQuestionBtn = document.getElementById('control-next-question-btn');
        const controlEndQuizBtn = document.getElementById('control-end-quiz-btn');
        const controlBackToDashboardBtn = document.getElementById('control-back-to-dashboard-btn');

        // Quiz results elements
        const recentResultsContainer = document.getElementById('recent-results-container');
        const allResultsContainer = document.getElementById('all-results-container');
        const topPerformersContainer = document.getElementById('top-performers-container');
        const backToDashboardFromResultsBtn = document.getElementById('back-to-dashboard-from-results-btn');
        const detailResultsContent = document.getElementById('detail-results-content');
        const backToResultsDashboardBtn = document.getElementById('back-to-results-dashboard-btn');

        // Santri join elements
        const quizPinInput = document.getElementById('quiz-pin');
        const santriDisplayNameInput = document.getElementById('santri-display-name');
        const joinQuizBtn = document.getElementById('join-quiz-btn');
        const cancelJoinBtn = document.getElementById('cancel-join-btn');
        const waitingPinElement = document.getElementById('waiting-pin');
        const waitingNameElement = document.getElementById('waiting-name');
        const leaveQuizBtn = document.getElementById('leave-quiz-btn');

        // Santri answer elements
        const santriQuestionNumber = document.getElementById('santri-question-number');
        const santriQuestionText = document.getElementById('santri-question-text');
        const santriTimer = document.getElementById('santri-timer');
        const santriAnswerOptions = document.getElementById('santri-answer-options');
        const santriQuestionStatus = document.getElementById('santri-question-status');
        const santriAnswerFeedback = document.getElementById('santri-answer-feedback');
        const submitAnswerBtn = document.getElementById('submit-answer-btn');

        // Lobby elements
        const lobbyElements = {
            pinCode: document.getElementById('pin-code'),
            playersList: document.getElementById('players-list'),
            startQuizFromLobbyBtn: document.getElementById('start-quiz-from-lobby-btn'),
            backToDashboardBtn: document.getElementById('back-to-dashboard-btn')
        };

        // Results elements
        const resultsElements = {
            winnerName: document.getElementById('winner-name'),
            winnerScore: document.getElementById('winner-score'),
            scoreboardList: document.getElementById('scoreboard-list'),
            backToDashboardFromFinalResultsBtn: document.getElementById('back-to-dashboard-from-final-results-btn'),
            saveResultsBtn: document.getElementById('save-results-btn')
        };

        // Notification function
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'exclamation-triangle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Initialize the app
        function initApp() {
            // MUAT DATA AWAL DARI LOCAL STORAGE
            loadData();

            // Setup WebSocket listeners untuk komunikasi real-time
            setupWebSocketListeners();
            
            // Add event listeners for role selection
            roleOptions.forEach(option => {
                option.addEventListener('click', () => {
                    roleOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                });
            });

            // Login button event
            loginBtn.addEventListener('click', handleLogin);

            // Ustadz dashboard events
            createQuizCard.addEventListener('click', () => {
                // Kosongkan form saat akan membuat kuis baru
                quizTitleInput.value = '';
                questionsContainer.innerHTML = '';
                // Tambahkan satu pertanyaan kosong untuk memulai
                addQuestionToForm(questionsContainer);
                switchScreen('createQuiz');
            });
            manageQuizCard.addEventListener('click', () => {
                loadManageQuizzesScreen();
                switchScreen('manageQuizzes');
            });
            startQuizCard.addEventListener('click', startQuizFromDashboard);
            viewResultsCard.addEventListener('click', () => {
                loadQuizResultsDashboard();
                switchScreen('quizResultsDashboard');
            });

            // Santri dashboard events
            joinQuizCard.addEventListener('click', () => {
                // Pastikan PIN kuis yang sebelumnya dimasukkan dikosongkan
                quizPinInput.value = '';
                // Pastikan Santri memuat data terbaru dari Local Storage saat akan join
                loadData(); 
                switchScreen('santriJoin');
            });
            santriResultsCard.addEventListener('click', showSantriResults);

            // Create quiz events
            addQuestionBtn.addEventListener('click', () => addQuestionToForm(questionsContainer));
            saveQuizBtn.addEventListener('click', saveQuiz);
            cancelCreateQuizBtn.addEventListener('click', () => {
                if (appData.userRole === 'ustadz') {
                    switchScreen('ustadzDashboard');
                }
            });

            // Edit quiz events
            addQuestionEditBtn.addEventListener('click', () => addQuestionToForm(editQuestionsContainer, true));
            updateQuizBtn.addEventListener('click', updateQuiz);
            cancelEditQuizBtn.addEventListener('click', () => {
                if (appData.userRole === 'ustadz') {
                    switchScreen('manageQuizzes');
                }
            });

            // Manage quizzes events
            backToDashboardFromManageBtn.addEventListener('click', () => {
                if (appData.userRole === 'ustadz') {
                    switchScreen('ustadzDashboard');
                }
            });

            // Tabs events
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    // Remove active class from all tabs
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Show corresponding content
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // Refresh content based on tab
                    if (appData.currentScreen === 'manageQuizzes') {
                        loadManageQuizzesScreen();
                    } else if (appData.currentScreen === 'quizResultsDashboard') {
                        loadQuizResultsDashboard();
                    }
                });
            });

            // Quiz control panel events
            controlNextQuestionBtn.addEventListener('click', controlNextQuestion);
            controlEndQuizBtn.addEventListener('click', controlEndQuiz);
            controlBackToDashboardBtn.addEventListener('click', () => {
                if (appData.userRole === 'ustadz') {
                    // Cek apakah ada kuis aktif yang harus dihentikan dulu
                    if (appData.currentQuiz && appData.activeQuizzes[appData.currentQuiz.pin]?.isActive) {
                        if (!confirm('Kuis sedang berlangsung. Apakah Anda yakin ingin mengakhiri dan kembali ke Dashboard?')) {
                            return;
                        }
                        // Kirim event berakhir ke santri jika Ustadz memaksakan keluar
                        QuizWebSocket.sendEvent('quiz-ended', { pin: appData.currentQuiz.pin });
                        delete appData.activeQuizzes[appData.currentQuiz.pin];
                        appData.currentQuiz = null;
                    }
                    switchScreen('ustadzDashboard');
                }
            });

            // Quiz results events
            backToDashboardFromResultsBtn.addEventListener('click', () => {
                if (appData.userRole === 'ustadz') {
                    switchScreen('ustadzDashboard');
                }
            });
            
            backToResultsDashboardBtn.addEventListener('click', () => {
                switchScreen('quizResultsDashboard');
            }
            );

            // Santri join events
            joinQuizBtn.addEventListener('click', joinQuiz);
            cancelJoinBtn.addEventListener('click', () => {
                if (appData.userRole === 'santri') {
                    switchScreen('santriDashboard');
                }
            });
            leaveQuizBtn.addEventListener('click', leaveQuiz);

            // Santri answer events
            submitAnswerBtn.addEventListener('click', submitSantriAnswer);

            // Lobby events
            lobbyElements.startQuizFromLobbyBtn.addEventListener('click', startQuizFromLobby);
            lobbyElements.backToDashboardBtn.addEventListener('click', () => {
                if (appData.userRole === 'ustadz') {
                    // Cek apakah ada kuis aktif yang harus dihentikan dulu
                    if (appData.currentQuiz) {
                        delete appData.activeQuizzes[appData.currentQuiz.pin];
                        appData.currentQuiz = null;
                    }
                    switchScreen('ustadzDashboard');
                }
            });

            // Results events
            resultsElements.backToDashboardFromFinalResultsBtn.addEventListener('click', () => {
                if (appData.userRole === 'ustadz') {
                    switchScreen('ustadzDashboard');
                }
            });
            resultsElements.saveResultsBtn.addEventListener('click', saveQuizResults);

        }

        // Setup WebSocket listeners untuk komunikasi real-time
        function setupWebSocketListeners() {
            // Santri mendengarkan event quiz dimulai
            QuizWebSocket.addEventListener('quiz-started', function(data) {
                if (appData.santriData.joinedQuiz && 
                    appData.santriData.currentQuizPin === data.pin &&
                    appData.currentScreen === 'santriWaiting') {
                    
                    // Load pertanyaan pertama setelah delay singkat
                    setTimeout(() => {
                        loadSantriQuestion();
                    }, 1000);
                }
            });

            // Santri mendengarkan event pertanyaan baru
            QuizWebSocket.addEventListener('new-question', function(data) {
                if (appData.santriData.joinedQuiz && 
                    appData.santriData.currentQuizPin === data.pin) {
                    
                    // Load pertanyaan baru
                    setTimeout(() => {
                        loadSantriQuestion();
                    }, 500);
                }
            });

            // Santri mendengarkan event quiz berakhir
            QuizWebSocket.addEventListener('quiz-ended', function(data) {
                if (appData.santriData.joinedQuiz && 
                    appData.santriData.currentQuizPin === data.pin) {
                    
                    // Show hasil akhir
                    setTimeout(() => {
                        showSantriFinalResults();
                    }, 1000);
                }
            });
        }
        
        // Handle login (logika demo login tetap sama)
        function handleLogin() {
            const selectedRole = document.querySelector('.role-option.active').dataset.role;
            const username = usernameInput.value.trim();
            const password = passwordInput.value;

            // Simple validation for demo
            if (!username || !password) {
                showNotification('Silakan isi nama pengguna dan kata sandi!', 'error');
                return;
            }

            // Demo authentication
            if (selectedRole === 'ustadz') {
                if (username === 'ustadz' && password === '123') {
                    appData.currentUser = { name: 'Ustadz Ahmad', role: 'ustadz' };
                    appData.userRole = 'ustadz';
                    loginSuccess();
                } else {
                    showNotification('Nama pengguna atau kata sandi salah untuk ustadz!', 'error');
                }
            } else if (selectedRole === 'santri') {
                if (username === 'santri' && password === '123') {
                    appData.currentUser = { name: 'Santri Al Aziziyyah', role: 'santri' };
                    appData.userRole = 'santri';
                    loginSuccess();
                } else {
                    showNotification('Nama pengguna atau kata sandi salah untuk santri!', 'error');
                }
            }
        }

        // Handle successful login
        function loginSuccess() {
            // Update header
            appHeader.classList.remove('hidden');
            userRoleSubtitle.textContent = appData.userRole === 'ustadz' ? 'Dashboard Ustadz' : 'Dashboard Santri';
            
            // Update user info in header
            userInfoElement.innerHTML = `
                <i class="fas fa-${appData.userRole === 'ustadz' ? 'user-tie' : 'user-graduate'}"></i>
                <span>${appData.currentUser.name}</span>
                <button class="logout-btn" id="logout-btn">Keluar</button>
            `;
            
            // Add logout event
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            // Switch to appropriate dashboard
            if (appData.userRole === 'ustadz') {
                ustadzNameElement.textContent = appData.currentUser.name;
                switchScreen('ustadzDashboard');
            } else {
                santriNameElement.textContent = appData.currentUser.name;
                // Set default name for santri join
                santriDisplayNameInput.value = appData.currentUser.name;
                switchScreen('santriDashboard');
            }
            
            // Clear login form
            usernameInput.value = '';
            passwordInput.value = '';
            
            showNotification('Login berhasil!', 'success');
        }

        // Logout function
        function logout() {
            appData.currentUser = null;
            appData.userRole = null;
            appHeader.classList.add('hidden');
            switchScreen('login');
            showNotification('Anda telah logout', 'warning');
        }

        // Switch between screens
        function switchScreen(screenName) {
            // Hide all screens
            Object.values(screens).forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show the requested screen
            screens[screenName].classList.add('active');
            appData.currentScreen = screenName;
        }

        // Add question to form
        function addQuestionToForm(container, isEdit = false) {
            const questionId = container.children.length + 1;
            const prefix = isEdit ? 'edit-' : '';
            
            const questionItem = document.createElement('div');
            questionItem.className = 'question-item';
            questionItem.innerHTML = `
                <div class="question-item-header">
                    <h3>Pertanyaan ${questionId}</h3>
                    <button type="button" class="remove-question">Hapus</button>
                </div>
                <div class="form-group">
                    <label for="${prefix}question-text-${questionId}">Teks Pertanyaan</label>
                    <input type="text" id="${prefix}question-text-${questionId}" class="form-control" placeholder="Masukkan teks pertanyaan">
                </div>
                <div class="form-group">
                    <label>Pilihan Jawaban (Centang jawaban yang benar)</label>
                    <div class="answer-option-input">
                        <input type="radio" name="${prefix}correct-answer-${questionId}" value="0" class="correct-answer-checkbox">
                        <input type="text" class="form-control" placeholder="Jawaban A">
                    </div>
                    <div class="answer-option-input">
                        <input type="radio" name="${prefix}correct-answer-${questionId}" value="1" class="correct-answer-checkbox">
                        <input type="text" class="form-control" placeholder="Jawaban B">
                    </div>
                    <div class="answer-option-input">
                        <input type="radio" name="${prefix}correct-answer-${questionId}" value="2" class="correct-answer-checkbox">
                        <input type="text" class="form-control" placeholder="Jawaban C">
                    </div>
                    <div class="answer-option-input">
                        <input type="radio" name="${prefix}correct-answer-${questionId}" value="3" class="correct-answer-checkbox">
                        <input type="text" class="form-control" placeholder="Jawaban D">
                    </div>
                </div>
                <div class="form-group">
                    <label for="${prefix}question-time-${questionId}">Waktu (detik)</label>
                    <input type="number" id="${prefix}question-time-${questionId}" class="form-control" value="15" min="5" max="60">
                </div>
            `;
            
            container.appendChild(questionItem);
            
            // Add event listener for remove button
            questionItem.querySelector('.remove-question').addEventListener('click', function() {
                questionItem.remove();
                updateQuestionNumbers(container);
            });
        }

        // Update question numbers after removal
        function updateQuestionNumbers(container) {
            const questionItems = container.querySelectorAll('.question-item');
            questionItems.forEach((item, index) => {
                item.querySelector('h3').textContent = `Pertanyaan ${index + 1}`;
                
                // Update all IDs in the question item
                const inputs = item.querySelectorAll('input, label');
                inputs.forEach(input => {
                    if (input.id) {
                        input.id = input.id.replace(/-\d+$/, `-${index + 1}`);
                    }
                    if (input.htmlFor) {
                        input.htmlFor = input.htmlFor.replace(/-\d+$/, `-${index + 1}`);
                    }
                });
                
                // Update radio button names
                const radios = item.querySelectorAll('input[type="radio"]');
                radios.forEach(radio => {
                    const name = radio.name;
                    radio.name = name.replace(/-\d+$/, `-${index + 1}`);
                });
            });
        }

        // Save quiz
        function saveQuiz() {
            const title = quizTitleInput.value.trim();
            if (!title) {
                showNotification('Silakan masukkan judul kuis!', 'error');
                return;
            }
            
            const questionItems = questionsContainer.querySelectorAll('.question-item');
            if (questionItems.length === 0) {
                showNotification('Silakan tambahkan minimal satu pertanyaan!', 'error');
                return;
            }
            
            const questions = [];
            let isValid = true;
            
            for (let i = 0; i < questionItems.length; i++) {
                const item = questionItems[i];
                const questionText = item.querySelector(`#question-text-${i + 1}`).value.trim();
                
                if (!questionText) {
                    showNotification(`Silakan isi teks pertanyaan untuk pertanyaan ${i + 1}!`, 'error');
                    isValid = false;
                    break;
                }
                
                const answerInputs = item.querySelectorAll('.answer-option-input input[type="text"]');
                const correctAnswerRadio = item.querySelector('input[type="radio"]:checked');
                const timeLimit = parseInt(item.querySelector(`#question-time-${i + 1}`).value) || 15;
                
                if (!correctAnswerRadio) {
                    showNotification(`Silakan pilih jawaban yang benar untuk pertanyaan ${i + 1}!`, 'error');
                    isValid = false;
                    break;
                }
                
                const answers = [];
                for (let j = 0; j < answerInputs.length; j++) {
                    const answerText = answerInputs[j].value.trim();
                    if (!answerText) {
                        showNotification(`Silakan isi semua pilihan jawaban untuk pertanyaan ${i + 1}!`, 'error');
                        isValid = false;
                        break;
                    }
                    
                    answers.push({
                        text: answerText,
                        correct: j === parseInt(correctAnswerRadio.value)
                    });
                }
                
                if (!isValid) break;
                
                questions.push({
                    text: questionText,
                    answers: answers,
                    timeLimit: timeLimit
                });
            }
            
            if (!isValid) return;
            
            // Generate random PIN (pastikan tidak ada yang sama)
            const pin = generateUniquePin();
            
            if (!pin) {
                showNotification('Gagal membuat PIN unik. Silakan coba lagi.', 'error');
                return;
            }
            
            // Save quiz
            const newQuiz = {
                id: appData.createdQuizzes.length + 1,
                title: title,
                pin: pin,
                questions: questions,
                status: 'draft',
                createdAt: new Date().toLocaleDateString('id-ID'),
                totalQuestions: questions.length,
                currentQuestionIndex: 0
            };
            
            appData.createdQuizzes.push(newQuiz);
            
            // Juga buat active quiz untuk PIN ini
            appData.activeQuizzes[pin] = {
                quiz: newQuiz,
                players: [],
                currentQuestionIndex: 0,
                isActive: false,
                startTime: null
            };

            // SIMPAN DATA KE LOCAL STORAGE
            saveData();
            
            showNotification(`Kuis "${title}" berhasil disimpan! Kode PIN: ${pin}`, 'success');
            
            // Clear form
            quizTitleInput.value = '';
            questionsContainer.innerHTML = '';
            
            // Return to dashboard
            switchScreen('ustadzDashboard');
        }

        // Edit quiz
        function editQuiz(quizId) {
            const quiz = appData.createdQuizzes.find(q => q.id === quizId);
            if (!quiz) return;
            
            appData.editingQuizId = quizId;
            editQuizTitleInput.value = quiz.title;
            editQuestionsContainer.innerHTML = '';
            
            // Add existing questions to edit form
            quiz.questions.forEach((question, index) => {
                addQuestionToEditForm(question, index + 1);
            });
            
            switchScreen('editQuiz');
        }

        // Add question to edit form
        function addQuestionToEditForm(question, questionNumber) {
            const questionItem = document.createElement('div');
            questionItem.className = 'question-item';
            questionItem.innerHTML = `
                <div class="question-item-header">
                    <h3>Pertanyaan ${questionNumber}</h3>
                    <button type="button" class="remove-question">Hapus</button>
                </div>
                <div class="form-group">
                    <label for="edit-question-text-${questionNumber}">Teks Pertanyaan</label>
                    <input type="text" id="edit-question-text-${questionNumber}" class="form-control" value="${question.text}" placeholder="Masukkan teks pertanyaan">
                </div>
                <div class="form-group">
                    <label>Pilihan Jawaban (Centang jawaban yang benar)</label>
                    ${question.answers.map((answer, index) => `
                        <div class="answer-option-input">
                            <input type="radio" name="edit-correct-answer-${questionNumber}" value="${index}" class="correct-answer-checkbox" ${answer.correct ? 'checked' : ''}>
                            <input type="text" class="form-control" value="${answer.text}" placeholder="Jawaban ${['A', 'B', 'C', 'D'][index]}">
                        </div>
                    `).join('')}
                </div>
                <div class="form-group">
                    <label for="edit-question-time-${questionNumber}">Waktu (detik)</label>
                    <input type="number" id="edit-question-time-${questionNumber}" class="form-control" value="${question.timeLimit || 15}" min="5" max="60">
                </div>
            `;
            
            editQuestionsContainer.appendChild(questionItem);
            
            // Add event listener for remove button
            questionItem.querySelector('.remove-question').addEventListener('click', function() {
                questionItem.remove();
                updateQuestionNumbers(editQuestionsContainer);
            });
        }

        // Update quiz
        function updateQuiz() {
            const title = editQuizTitleInput.value.trim();
            if (!title) {
                showNotification('Silakan masukkan judul kuis!', 'error');
                return;
            }
            
            const questionItems = editQuestionsContainer.querySelectorAll('.question-item');
            if (questionItems.length === 0) {
                showNotification('Silakan tambahkan minimal satu pertanyaan!', 'error');
                return;
            }
            
            const questions = [];
            let isValid = true;
            
            for (let i = 0; i < questionItems.length; i++) {
                const item = questionItems[i];
                const questionText = item.querySelector(`#edit-question-text-${i + 1}`).value.trim();
                
                if (!questionText) {
                    showNotification(`Silakan isi teks pertanyaan untuk pertanyaan ${i + 1}!`, 'error');
                    isValid = false;
                    break;
                }
                
                const answerInputs = item.querySelectorAll('.answer-option-input input[type="text"]');
                const correctAnswerRadio = item.querySelector('input[type="radio"]:checked');
                const timeLimit = parseInt(item.querySelector(`#edit-question-time-${i + 1}`).value) || 15;
                
                if (!correctAnswerRadio) {
                    showNotification(`Silakan pilih jawaban yang benar untuk pertanyaan ${i + 1}!`, 'error');
                    isValid = false;
                    break;
                }
                
                const answers = [];
                for (let j = 0; j < answerInputs.length; j++) {
                    const answerText = answerInputs[j].value.trim();
                    if (!answerText) {
                        showNotification(`Silakan isi semua pilihan jawaban untuk pertanyaan ${i + 1}!`, 'error');
                        isValid = false;
                        break;
                    }
                    
                    answers.push({
                        text: answerText,
                        correct: j === parseInt(correctAnswerRadio.value)
                    });
                }
                
                if (!isValid) break;
                
                questions.push({
                    text: questionText,
                    answers: answers,
                    timeLimit: timeLimit
                });
            }
            
            if (!isValid) return;
            
            // Find and update quiz
            const quizIndex = appData.createdQuizzes.findIndex(q => q.id === appData.editingQuizId);
            if (quizIndex !== -1) {
                const oldPin = appData.createdQuizzes[quizIndex].pin;
                appData.createdQuizzes[quizIndex].title = title;
                appData.createdQuizzes[quizIndex].questions = questions;
                appData.createdQuizzes[quizIndex].totalQuestions = questions.length;
                
                // Update active quiz data juga
                if (appData.activeQuizzes[oldPin]) {
                    appData.activeQuizzes[oldPin].quiz = appData.createdQuizzes[quizIndex];
                }

                // SIMPAN DATA KE LOCAL STORAGE
                saveData();
                
                showNotification(`Kuis "${title}" berhasil diperbarui!`, 'success');
                
                // Clear edit data
                appData.editingQuizId = null;
                editQuizTitleInput.value = '';
                editQuestionsContainer.innerHTML = '';
                
                // Return to manage quizzes
                loadManageQuizzesScreen();
                switchScreen('manageQuizzes');
            }
        }

        // Load manage quizzes screen
        function loadManageQuizzesScreen() {
            // MUAT DATA SEBELUM MENAMPILKAN
            loadData();

            // Clear containers
            quizzesListContainer.innerHTML = '';
            draftQuizzesContainer.innerHTML = '';
            activeQuizzesContainer.innerHTML = '';
            
            // Filter quizzes by status
            const allQuizzes = appData.createdQuizzes;
            const draftQuizzes = appData.createdQuizzes.filter(q => q.status === 'draft');
            const activeQuizzes = appData.createdQuizzes.filter(q => q.status === 'active');
            
            // Display all quizzes
            if (allQuizzes.length > 0) {
                allQuizzes.forEach(quiz => {
                    quizzesListContainer.appendChild(createQuizCardElement(quiz));
                });
            } else {
                quizzesListContainer.innerHTML = createEmptyState('Belum ada kuis yang dibuat', 'fas fa-clipboard-list');
            }
            
            // Display draft quizzes
            if (draftQuizzes.length > 0) {
                draftQuizzes.forEach(quiz => {
                    draftQuizzesContainer.appendChild(createQuizCardElement(quiz));
                });
            } else {
                draftQuizzesContainer.innerHTML = createEmptyState('Belum ada kuis dalam draft', 'fas fa-edit');
            }
            
            // Display active quizzes
            if (activeQuizzes.length > 0) {
                activeQuizzes.forEach(quiz => {
                    activeQuizzesContainer.appendChild(createQuizCardElement(quiz));
                });
            } else {
                activeQuizzesContainer.innerHTML = createEmptyState('Belum ada kuis aktif', 'fas fa-play-circle');
            }
        }

        // Create quiz card element
        function createQuizCardElement(quiz) {
            const card = document.createElement('div');
            card.className = 'quiz-card';
            
            card.innerHTML = `
                <div class="quiz-card-header">
                    <div>
                        <div class="quiz-card-title">${quiz.title}</div>
                        <div class="quiz-card-pin">PIN: ${quiz.pin}</div>
                    </div>
                    <span class="quiz-status ${quiz.status === 'active' ? 'active-status' : 'draft-status'}">
                        ${quiz.status === 'active' ? 'Aktif' : 'Draft'}
                    </span>
                </div>
                <div class="quiz-card-info">
                    <span><i class="fas fa-question-circle"></i> ${quiz.totalQuestions} Pertanyaan</span>
                    <span><i class="fas fa-calendar"></i> ${quiz.createdAt}</span>
                </div>
                <p style="color: #666; margin-bottom: 15px;">Kuis tentang ${quiz.title.toLowerCase()} untuk santri PP Al Aziziyyah</p>
                <div class="quiz-card-actions">
                    ${quiz.status === 'draft' ? `
                        <button class="action-btn action-btn-primary" data-quiz-id="${quiz.id}" data-action="activate">
                            <i class="fas fa-check"></i> Aktifkan
                        </button>
                    ` : `
                        <button class="action-btn action-btn-primary" data-quiz-id="${quiz.id}" data-action="start">
                            <i class="fas fa-play"></i> Mulai
                        </button>
                    `}
                    <button class="action-btn action-btn-warning" data-quiz-id="${quiz.id}" data-action="edit">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="action-btn action-btn-outline" data-quiz-id="${quiz.id}" data-action="duplicate">
                        <i class="fas fa-copy"></i> Duplikat
                    </button>
                    <button class="action-btn action-btn-danger" data-quiz-id="${quiz.id}" data-action="delete">
                        <i class="fas fa-trash"></i> Hapus
                    </button>
                </div>
            `;
            
            // Add event listeners to buttons
            const buttons = card.querySelectorAll('.action-btn');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    const quizId = parseInt(this.dataset.quizId);
                    const action = this.dataset.action;
                    handleQuizAction(quizId, action);
                });
            });
            
            return card;
        }

        // Handle quiz actions
        function handleQuizAction(quizId, action) {
            const quiz = appData.createdQuizzes.find(q => q.id === quizId);
            
            if (!quiz) return;
            
            
            switch(action) {
                case 'activate':
                    if (quiz.totalQuestions === 0) {
                        showNotification('Kuis ini belum memiliki pertanyaan. Harap edit kuis terlebih dahulu.', 'error');
                        return;
                    }
                    quiz.status = 'active';
                    // Pastikan inisialisasi aktif kuis di sini (clear players jika sudah ada)
                    appData.activeQuizzes[quiz.pin] = {
                        quiz: quiz,
                        players: [],
                        currentQuestionIndex: 0,
                        isActive: false,
                        startTime: null
                    };
                    loadManageQuizzesScreen();

                    // SIMPAN PERUBAHAN STATUS KE LOCAL STORAGE
                    saveData();
                    
                    showNotification(`Kuis "${quiz.title}" telah diaktifkan! Santri dapat bergabung menggunakan PIN ${quiz.pin}.`, 'success');
                    break;
                    
                case 'start':
                    if (quiz.totalQuestions === 0) {
                        showNotification('Kuis ini belum memiliki pertanyaan. Harap edit kuis terlebih dahulu.', 'error');
                        return;
                    }
                    // PERBAIKAN: Jika kuis masih draft, otomatis ubah status menjadi active saat Ustadz klik "Mulai"
                    if (quiz.status === 'draft') {
                        quiz.status = 'active';
                        // SIMPAN PERUBAHAN STATUS KE LOCAL STORAGE
                        saveData();
                        loadManageQuizzesScreen(); // Refresh tampilan manage
                    }
                    startQuizAsUstadz(quiz);
                    break;
                    
                case 'edit':
                    editQuiz(quizId);
                    break;
                    
                case 'duplicate':
                    // Create a duplicate quiz
                    const duplicateQuiz = {
                        ...quiz,
                        id: appData.createdQuizzes.length + 1,
                        title: `${quiz.title} (Salinan)`,
                        pin: generateUniquePin(),
                        status: 'draft',
                        createdAt: new Date().toLocaleDateString('id-ID'),
                        questions: JSON.parse(JSON.stringify(quiz.questions)) // deep copy
                    };
                    
                    appData.createdQuizzes.push(duplicateQuiz);
                    
                    // Juga buat active quiz untuk PIN baru
                    appData.activeQuizzes[duplicateQuiz.pin] = {
                        quiz: duplicateQuiz,
                        players: [],
                        currentQuestionIndex: 0,
                        isActive: false,
                        startTime: null
                    };

                    // SIMPAN DATA KE LOCAL STORAGE
                    saveData();
                    
                    loadManageQuizzesScreen();
                    showNotification(`Kuis "${quiz.title}" telah diduplikasi dengan PIN baru: ${duplicateQuiz.pin}!`, 'success');
                    break;
                    
                case 'delete':
                    if (confirm(`Apakah Anda yakin ingin menghapus kuis "${quiz.title}"?`)) {
                        const index = appData.createdQuizzes.findIndex(q => q.id === quizId);
                        if (index !== -1) {
                            // Hapus dari active quizzes juga
                            if (appData.activeQuizzes[quiz.pin]) {
                                delete appData.activeQuizzes[quiz.pin];
                            }
                            
                            appData.createdQuizzes.splice(index, 1);
                            
                            // SIMPAN DATA KE LOCAL STORAGE
                            saveData();
                            
                            loadManageQuizzesScreen();
                            showNotification(`Kuis "${quiz.title}" telah dihapus!`, 'success');
                        }
                    }
                    break;
            }
        }
        
        // Helper function to generate a unique PIN
        function generateUniquePin() {
            let pin;
            let attempts = 0;
            const existingPins = appData.createdQuizzes.map(q => q.pin);
            do {
                pin = Math.floor(1000 + Math.random() * 9000).toString();
                attempts++;
            } while (existingPins.includes(pin) && attempts < 10);
            return pin;
        }


        // Start quiz as ustadz (control panel)
        function startQuizAsUstadz(quiz) {
            if (quiz.totalQuestions === 0) {
                showNotification('Kuis ini belum memiliki pertanyaan. Harap edit kuis terlebih dahulu.', 'error');
                return;
            }

            appData.currentQuiz = quiz;
            
            // Inisialisasi/reset active quiz data (penting untuk menghapus pemain dari sesi sebelumnya)
            appData.activeQuizzes[quiz.pin] = {
                quiz: quiz,
                players: [],
                currentQuestionIndex: 0,
                isActive: false,
                startTime: null
            };
            
            // Update PIN in lobby
            lobbyElements.pinCode.textContent = quiz.pin;
            
            // Update control panel info awal
            controlQuizTitle.textContent = quiz.title;
            controlQuizPin.textContent = quiz.pin;
            controlQuestionNumber.textContent = `0/${quiz.questions.length}`; 
            controlQuestionNumberText.textContent = `Pertanyaan 0 dari ${quiz.questions.length}`;
            controlQuestionText.textContent = 'Menunggu kuis dimulai...';
            
            // Muat daftar pemain saat masuk lobby
            updateLobbyPlayersList();
            
            // Show lobby first
            switchScreen('lobby');
            
            showNotification(`Kuis "${quiz.title}" siap dimulai! Berikan PIN ${quiz.pin} kepada santri.`, 'success');
        }

        // Start quiz from lobby
        function startQuizFromLobby() {
            if (!appData.currentQuiz) return;
            
            const activeQuiz = appData.activeQuizzes[appData.currentQuiz.pin];
            if (!activeQuiz) return;
            
            if (appData.currentQuiz.questions.length === 0) {
                 showNotification('Kuis ini belum memiliki pertanyaan.', 'error');
                 return;
            }
            
            // Check if there are players
            if (activeQuiz.players.length === 0) {
                showNotification('Belum ada santri yang bergabung. Tunggu santri bergabung terlebih dahulu.', 'warning');
                return;
            }
            
            // Start the quiz
            activeQuiz.isActive = true;
            activeQuiz.startTime = new Date();
            activeQuiz.currentQuestionIndex = 0; // Mulai dari pertanyaan pertama (index 0)
            
            // Update control panel info pertanyaan pertama
            controlQuestionNumber.textContent = `${activeQuiz.currentQuestionIndex + 1}/${appData.currentQuiz.questions.length}`;
            controlQuestionNumberText.textContent = `Pertanyaan ${activeQuiz.currentQuestionIndex + 1} dari ${appData.currentQuiz.questions.length}`;
            controlQuestionText.textContent = appData.currentQuiz.questions[activeQuiz.currentQuestionIndex].text;
            
            // Switch to control panel
            switchScreen('quizControlPanel');
            
            // Update control panel with current players
            updateControlPlayersList();
            
            // Kirim event ke semua santri bahwa kuis telah dimulai
            QuizWebSocket.sendEvent('quiz-started', {
                pin: appData.currentQuiz.pin,
                quizTitle: appData.currentQuiz.title
            });
            
            // Kirim pertanyaan pertama ke semua santri
            // Penundaan 1 detik untuk memberikan waktu Santri beralih ke layar Jawaban
            setTimeout(() => {
                QuizWebSocket.sendEvent('new-question', {
                    pin: appData.currentQuiz.pin,
                    questionIndex: 0
                });
            }, 1000);
            
            showNotification('Kuis dimulai! Pertanyaan pertama telah dikirim ke semua santri.', 'success');
        }

        // Update control players list (di Quiz Control Panel)
        function updateControlPlayersList() {
            // Hanya jalankan jika Ustadz berada di layar kontrol
            if (appData.userRole !== 'ustadz' || appData.currentScreen !== 'quizControlPanel') return;
            if (!appData.currentQuiz) return;
            
            const activeQuiz = appData.activeQuizzes[appData.currentQuiz.pin];
            if (!activeQuiz) return;
            
            controlPlayersList.innerHTML = '';
            controlPlayerCount.textContent = activeQuiz.players.length;
            
            activeQuiz.players.sort((a, b) => b.score - a.score); // Urutkan berdasarkan skor
            
            activeQuiz.players.forEach(player => {
                const playerElement = document.createElement('div');
                playerElement.className = 'player';
                playerElement.innerHTML = `
                    <i class="fas fa-user-graduate"></i>
                    <span>${player.name}</span>
                    <span style="margin-left: auto; color: #28a745; font-weight: 600;">${player.score} pts</span>
                `;
                controlPlayersList.appendChild(playerElement);
            });
        }

        // Control next question
        function controlNextQuestion() {
            if (!appData.currentQuiz) return;
            
            const activeQuiz = appData.activeQuizzes[appData.currentQuiz.pin];
            if (!activeQuiz) return;
            
            // Move to next question
            activeQuiz.currentQuestionIndex++;
            
            if (activeQuiz.currentQuestionIndex >= appData.currentQuiz.questions.length) {
                // End of quiz
                controlEndQuiz();
                return;
            }
            
            // Update control panel
            controlQuestionNumber.textContent = `${activeQuiz.currentQuestionIndex + 1}/${appData.currentQuiz.questions.length}`;
            controlQuestionNumberText.textContent = `Pertanyaan ${activeQuiz.currentQuestionIndex + 1} dari ${appData.currentQuiz.questions.length}`;
            controlQuestionText.textContent = appData.currentQuiz.questions[activeQuiz.currentQuestionIndex].text;
            
            // Kirim event pertanyaan baru ke semua santri
            QuizWebSocket.sendEvent('new-question', {
                pin: appData.currentQuiz.pin,
                questionIndex: activeQuiz.currentQuestionIndex
            });
            
            showNotification(`Pertanyaan ${activeQuiz.currentQuestionIndex + 1} telah dikirim!`, 'success');
        }

        // Control end quiz
        function controlEndQuiz() {
            if (!appData.currentQuiz) return;
            
            const activeQuiz = appData.activeQuizzes[appData.currentQuiz.pin];
            if (!activeQuiz) return;
            
            // Calculate results
            const sortedPlayers = [...activeQuiz.players].sort((a, b) => b.score - a.score);
            
            // Update results screen
            if (sortedPlayers.length > 0) {
                resultsElements.winnerName.textContent = sortedPlayers[0].name;
                resultsElements.winnerScore.textContent = sortedPlayers[0].score;
                
                // Update scoreboard
                resultsElements.scoreboardList.innerHTML = '';
                sortedPlayers.forEach((player, index) => {
                    const scoreItem = document.createElement('div');
                    scoreItem.className = 'score-item';
                    
                    let rankClass = '';
                    if (index === 0) rankClass = 'rank-1';
                    else if (index === 1) rankClass = 'rank-2';
                    else if (index === 2) rankClass = 'rank-3';
                    
                    scoreItem.innerHTML = `
                        <div class="player-rank">
                            <div class="rank ${rankClass}">${index + 1}</div>
                            <i class="fas fa-user-graduate"></i>
                            <span>${player.name}</span>
                        </div>
                        <div class="player-score">${player.score} pts</div>
                    `;
                    
                    resultsElements.scoreboardList.appendChild(scoreItem);
                });
            } else {
                resultsElements.winnerName.textContent = 'Tidak ada peserta';
                resultsElements.winnerScore.textContent = '0';
                resultsElements.scoreboardList.innerHTML = createEmptyState('Tidak ada peserta di kuis ini.', 'fas fa-users');
            }
            
            // Mark quiz as finished
            activeQuiz.isActive = false;
            
            // Switch to results screen
            switchScreen('results');
            
            // Kirim event quiz berakhir ke semua santri
            QuizWebSocket.sendEvent('quiz-ended', {
                pin: appData.currentQuiz.pin
            });
            
            showNotification('Kuis telah berakhir! Hasil telah ditampilkan.', 'success');
        }

        // Start quiz from dashboard
        function startQuizFromDashboard() {
            const activeQuizzesList = appData.createdQuizzes.filter(q => q.status === 'active');

            if (appData.createdQuizzes.length === 0) {
                showNotification('Belum ada kuis yang dibuat. Silakan buat kuis terlebih dahulu!', 'error');
                return;
            }
            
            if (activeQuizzesList.length === 0) {
                showNotification('Belum ada kuis yang berstatus "Aktif". Silakan aktifkan kuis dari menu Kelola Kuis!', 'warning');
                return;
            }

            // Ambil kuis aktif pertama yang tersedia
            const quizToStart = activeQuizzesList[0];
            
            if (quizToStart.totalQuestions === 0) {
                 showNotification(`Kuis "${quizToStart.title}" belum memiliki pertanyaan. Harap edit kuis terlebih dahulu.`, 'error');
                 return;
            }
            
            startQuizAsUstadz(quizToStart);
        }

        // Fungsi Join Quiz yang sudah diperbaiki logikanya
        function joinQuiz() {
            const pin = quizPinInput.value.trim();
            const displayName = santriDisplayNameInput.value.trim();

            // PENTING: Muat data terbaru sebelum memproses
            loadData();
            
            if (!pin) {
                showNotification('Silakan masukkan kode PIN kuis!', 'error');
                return;
            }
            
            if (!displayName) {
                showNotification('Silakan masukkan nama tampilan!', 'error');
                return;
            }
            
            // Cek apakah PIN adalah 4 digit angka
            if (!/^\d{4}$/.test(pin)) {
                showNotification('Kode PIN harus 4 digit angka!', 'error');
                return;
            }
            
            // 1. Cari kuis di semua kuis yang dibuat (createdQuizzes)
            let foundQuiz = appData.createdQuizzes.find(q => q.pin === pin);

            if (!foundQuiz) {
                showNotification('Kuis dengan PIN tersebut tidak ditemukan! Pastikan PIN yang dimasukkan benar atau hubungi ustadz.', 'error');
                return;
            }

            // 2. Pastikan kuis memiliki pertanyaan
            if (!foundQuiz.questions || foundQuiz.questions.length === 0) {
                 showNotification('Kuis ini belum memiliki pertanyaan. Silakan hubungi ustadz.', 'error');
                 return;
            }
            
            // 3. Inisialisasi/ambil kuis aktif (activeQuizzes)
            let activeQuiz = appData.activeQuizzes[pin];

            // PERBAIKAN KRUSIAL: Inisialisasi ulang activeQuiz jika belum ada atau statusnya tidak sinkron.
            // Santri harus dapat bergabung jika PIN ditemukan di data persisten (createdQuizzes).
            if (!activeQuiz || activeQuiz.quiz.id !== foundQuiz.id) {
                 // Gunakan data dari createdQuizzes untuk membuat activeQuiz baru
                 appData.activeQuizzes[pin] = {
                    quiz: foundQuiz,
                    players: [],
                    currentQuestionIndex: 0,
                    isActive: false,
                    startTime: null
                 };
                 activeQuiz = appData.activeQuizzes[pin];

                 // Jika Santri bergabung, kuis harus otomatis dianggap 'active' di sisi Santri
                 foundQuiz.status = 'active'; // Sinkronisasi status
                 saveData(); // Simpan status 'active' ke storage
            } else {
                 // Cek apakah kuis sudah selesai
                 if (activeQuiz.isActive === false && activeQuiz.startTime !== null && activeQuiz.players.length > 0) {
                    showNotification('Kuis ini sudah selesai atau diakhiri.', 'error');
                    return;
                 }
            }

            // 4. Cek apakah pemain sudah ada
            const existingPlayer = activeQuiz.players.find(p => p.name === displayName);
            
            if (existingPlayer) {
                showNotification(`Nama "${displayName}" sudah digunakan di kuis ini. Silakan gunakan nama lain.`, 'error');
                return;
            }
            
            // 5. Tambahkan pemain baru
            activeQuiz.players.push({
                id: activeQuiz.players.length + 1,
                name: displayName,
                score: 0,
                answers: []
            });
            
            // Set santri data
            appData.santriData.joinedQuiz = true;
            appData.santriData.currentQuizPin = pin;
            appData.santriData.displayName = displayName;
            appData.santriData.score = 0;
            appData.santriData.answers = [];
            appData.santriData.answerSubmitted = false;
            
            // Set waiting data
            waitingPinElement.textContent = pin;
            waitingNameElement.textContent = displayName;
            
            // Kirim event ke Ustadz bahwa ada Santri yang bergabung
            QuizWebSocket.sendEvent('player-joined', { pin: pin, playerName: displayName });
            
            // Switch to waiting screen
            switchScreen('santriWaiting');
            
            // Clear inputs
            quizPinInput.value = '';
            
            // Show success message
            showNotification(`Berhasil bergabung ke kuis "${foundQuiz.title}"!`, 'success');
        }

        // Update lobby players list (di Lobby Screen)
        function updateLobbyPlayersList() {
            // Hanya jalankan jika Ustadz berada di layar Lobby
            if (appData.userRole !== 'ustadz' || appData.currentScreen !== 'lobby') return;
            if (!appData.currentQuiz) return;
            
            const activeQuiz = appData.activeQuizzes[appData.currentQuiz.pin];
            if (!activeQuiz) return;
            
            // Update lobby display
            lobbyElements.playersList.innerHTML = '';
            
            activeQuiz.players.forEach(player => {
                const playerElement = document.createElement('div');
                playerElement.className = 'player';
                playerElement.innerHTML = `
                    <i class="fas fa-user-graduate"></i>
                    <span>${player.name}</span>
                `;
                lobbyElements.playersList.appendChild(playerElement);
            });
            
            // Update player count
            controlPlayerCount.textContent = activeQuiz.players.length;
        }

        // Leave quiz
        function leaveQuiz() {
            const pinToLeave = appData.santriData.currentQuizPin;
            const displayNameToLeave = appData.santriData.displayName;

            if (pinToLeave && displayNameToLeave) {
                const activeQuiz = appData.activeQuizzes[pinToLeave];
                if (activeQuiz) {
                    // Remove player from active quiz
                    const playerIndex = activeQuiz.players.findIndex(p => p.name === displayNameToLeave);
                    if (playerIndex !== -1) {
                        activeQuiz.players.splice(playerIndex, 1);
                        
                        // Kirim event ke Ustadz bahwa Santri keluar (untuk update list)
                        if (appData.currentQuiz && appData.currentQuiz.pin === pinToLeave) {
                            updateControlPlayersList();
                            updateLobbyPlayersList();
                        }
                    }
                }
            }
            
            // Reset santri data
            appData.santriData.joinedQuiz = false;
            appData.santriData.currentQuizPin = null;
            appData.santriData.displayName = null;
            appData.santriData.score = 0;
            appData.santriData.answers = [];
            appData.santriData.answerSubmitted = false;
            
            // Clear timer
            if (appData.quizTimer) {
                clearInterval(appData.quizTimer);
                appData.quizTimer = null;
            }
            
            switchScreen('santriDashboard');
            showNotification('Anda telah keluar dari kuis.', 'warning');
        }

        // Load question for santri (dipanggil ketika menerima event dari WebSocket)
        function loadSantriQuestion() {
            if (!appData.santriData.joinedQuiz || !appData.santriData.currentQuizPin) {
                switchScreen('santriDashboard');
                return;
            }
            
            const activeQuiz = appData.activeQuizzes[appData.santriData.currentQuizPin];
            if (!activeQuiz || !activeQuiz.isActive) {
                switchScreen('santriWaiting');
                return;
            }
            
            const quiz = activeQuiz.quiz;
            const currentQuestionIndex = activeQuiz.currentQuestionIndex;
            
            if (currentQuestionIndex >= quiz.questions.length) {
                // End of quiz (harusnya sudah dihandle oleh event 'quiz-ended')
                showSantriFinalResults();
                return;
            }
            
            const question = quiz.questions[currentQuestionIndex];
            
            // Update question info
            santriQuestionNumber.textContent = `Pertanyaan ${currentQuestionIndex + 1} dari ${quiz.questions.length}`;
            santriQuestionText.textContent = question.text;
            
            // Update question status dots
            updateQuestionStatusDots(quiz.questions.length, currentQuestionIndex);
            
            // Reset answer state
            appData.santriData.answerSubmitted = false;
            appData.santriData.selectedAnswer = null;
            santriAnswerFeedback.classList.add('hidden');
            
            // Clear previous answers
            santriAnswerOptions.innerHTML = '';
            
            // Tampilkan tombol Kirim Jawaban
            submitAnswerBtn.classList.remove('hidden');
            
            // Create answer options
            question.answers.forEach((answer, index) => {
                const answerOption = document.createElement('div');
                answerOption.className = 'santri-answer-option';
                answerOption.innerHTML = `
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #0a3d62; color: white; display: flex; align-items: center; justify-content: center; font-weight: 800;">
                        ${['A', 'B', 'C', 'D'][index]}
                    </div>
                    <span>${answer.text}</span>
                `;
                
                // Add click event
                answerOption.addEventListener('click', () => {
                    if (appData.santriData.answerSubmitted) return;
                    
                    // Remove selection from all options
                    document.querySelectorAll('.santri-answer-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Select this option
                    answerOption.classList.add('selected');
                    appData.santriData.selectedAnswer = {
                        answer: answer,
                        questionIndex: currentQuestionIndex,
                        optionIndex: index
                    };
                });
                
                santriAnswerOptions.appendChild(answerOption);
            });
            
            // Start timer
            startSantriTimer(question.timeLimit);
            
            // Switch to answer screen
            switchScreen('santriAnswer');
        }

        // Update question status dots
        function updateQuestionStatusDots(totalQuestions, currentQuestionIndex) {
            santriQuestionStatus.innerHTML = '';
            
            for (let i = 0; i < totalQuestions; i++) {
                const dot = document.createElement('div');
                dot.className = 'question-status-dot';
                
                // Check if this question index has been answered by the Santri
                const isAnswered = appData.santriData.answers.some(a => a.questionIndex === i);

                if (i < currentQuestionIndex || isAnswered) {
                    dot.classList.add('answered');
                } else if (i === currentQuestionIndex) {
                    dot.classList.add('current');
                }
                
                santriQuestionStatus.appendChild(dot);
            }
        }

        // Start timer for santri
        function startSantriTimer(seconds) {
            // Clear any existing timer
            if (appData.quizTimer) {
                clearInterval(appData.quizTimer);
            }
            
            appData.quizTimeLeft = seconds;
            updateSantriTimerDisplay();
            
            appData.quizTimer = setInterval(() => {
                appData.quizTimeLeft--;
                updateSantriTimerDisplay();
                
                // Time's up
                if (appData.quizTimeLeft <= 0) {
                    clearInterval(appData.quizTimer);
                    appData.quizTimer = null;
                    submitSantriAnswer(true);
                }
            }, 1000);
        }

        // Update santri timer display
        function updateSantriTimerDisplay() {
            santriTimer.textContent = appData.quizTimeLeft;
            
            // Update timer color based on time left
            santriTimer.className = 'santri-timer';
            if (appData.quizTimeLeft <= 5) {
                santriTimer.classList.add('danger');
            } else if (appData.quizTimeLeft <= 10) {
                santriTimer.classList.add('warning');
            }
        }

        // Submit santri answer
        function submitSantriAnswer(isTimeUp = false) {
            if (appData.santriData.answerSubmitted) return;
            
            
            // Cek apakah Santri memilih jawaban saat waktu belum habis
            if (!appData.santriData.selectedAnswer && !isTimeUp) {
                showNotification('Silakan pilih jawaban terlebih dahulu!', 'error');
                return;
            }

            appData.santriData.answerSubmitted = true;

            // Stop timer
            if (appData.quizTimer) {
                clearInterval(appData.quizTimer);
                appData.quizTimer = null;
            }
            
            
            const activeQuiz = appData.activeQuizzes[appData.santriData.currentQuizPin];
            if (!activeQuiz) return;
            
            const question = activeQuiz.quiz.questions[activeQuiz.currentQuestionIndex];
            const isCorrect = appData.santriData.selectedAnswer && 
                             appData.santriData.selectedAnswer.answer.correct;
            
            // Calculate points based on time left
            const points = isCorrect ? (isTimeUp ? 1 : appData.quizTimeLeft * 10) : 0; // Poin minimum 1 jika benar saat waktu habis
            
            // Update santri score
            appData.santriData.score += points;
            
            // Update player score in active quiz
            const player = activeQuiz.players.find(p => p.name === appData.santriData.displayName);
            if (player) {
                player.score += points;
                player.answers.push({
                    questionIndex: activeQuiz.currentQuestionIndex,
                    isCorrect: isCorrect,
                    points: points
                });
                
                // Update control panel di Ustadz melalui panggilan langsung (simulasi WebSocket)
                updateControlPlayersList();
            }
            
            // Record answer
            appData.santriData.answers.push({
                questionIndex: activeQuiz.currentQuestionIndex,
                isCorrect: isCorrect,
                points: points,
                timeLeft: appData.quizTimeLeft
            });
            
            // Hide submit button
            submitAnswerBtn.classList.add('hidden');
            
            // Show feedback
            santriAnswerFeedback.classList.remove('hidden');
            santriAnswerFeedback.className = `answer-feedback ${isCorrect ? 'correct' : 'incorrect'}`;
            santriAnswerFeedback.innerHTML = `
                <i class="fas fa-${isCorrect ? 'check-circle' : 'times-circle'}"></i>
                ${isCorrect ? 
                    `Jawaban Benar! +${points} poin` : 
                    'Jawaban Salah! Tidak mendapatkan poin'}
            `;
            
            // Highlight correct answer
            const answerOptions = document.querySelectorAll('.santri-answer-option');
            question.answers.forEach((answer, index) => {
                if (answer.correct) {
                    answerOptions[index].classList.add('correct');
                }
            });

            // Highlight selected answer (if not time up)
            if (appData.santriData.selectedAnswer && !isTimeUp) {
                const selectedOption = document.querySelector('.santri-answer-option.selected');
                if (selectedOption) {
                    selectedOption.classList.add(isCorrect ? 'correct' : 'incorrect');
                }
            }
            
            // Disable further interaction
            document.querySelectorAll('.santri-answer-option').forEach(opt => {
                opt.style.pointerEvents = 'none';
            });
            
            // Wait for next question
            setTimeout(() => {
                if (appData.santriData.joinedQuiz) {
                    // Kembali ke waiting screen untuk menunggu pertanyaan berikutnya
                    switchScreen('santriWaiting');
                }
            }, 3000);
        }

        // Show santri final results
        function showSantriFinalResults() {
            if (!appData.santriData.joinedQuiz) return;
            
            const activeQuiz = appData.activeQuizzes[appData.santriData.currentQuizPin];
            if (!activeQuiz) return;
            
            // Find player ranking
            const sortedPlayers = [...activeQuiz.players].sort((a, b) => b.score - a.score);
            const playerRank = sortedPlayers.findIndex(p => p.name === appData.santriData.displayName) + 1;
            const totalPlayers = sortedPlayers.length;
            
            let message = `Hasil Kuis: ${activeQuiz.quiz.title}\n\n`;
            message += `Nama: ${appData.santriData.displayName}\n`;
            message += `Skor Akhir: ${appData.santriData.score} poin\n`;
            message += `Peringkat: ${playerRank} dari ${totalPlayers} peserta\n\n`;
            
            message += 'Detail Jawaban:\n';
            appData.santriData.answers.forEach((answer, index) => {
                const question = activeQuiz.quiz.questions[index];
                if (question) {
                    message += `${index + 1}. ${question.text.substring(0, 30)}... - `;
                    message += `${answer.isCorrect ? 'Benar' : 'Salah'} (${answer.points} poin)\n`;
                }
            });
            
            // Show alert dengan hasil
            alert(message);
            
            // Reset santri data
            appData.santriData.joinedQuiz = false;
            appData.santriData.currentQuizPin = null;
            appData.santriData.displayName = null;
            appData.santriData.score = 0;
            appData.santriData.answers = [];
            appData.santriData.answerSubmitted = false;
            
            // Kembali ke dashboard santri
            switchScreen('santriDashboard');
        }

        // Show santri results from dashboard
        function showSantriResults() {
            // Logika ini hanya menampilkan hasil kuis yang terakhir dimainkan oleh santri
            if (appData.santriData.answers.length === 0) {
                showNotification('Anda belum menyelesaikan kuis apapun.', 'warning');
                return;
            }
            
            let message = `Hasil Kuis Terakhir\n\n`;
            message += `Nama: ${appData.currentUser.name}\n`;
            message += `Skor Total: ${appData.santriData.score} poin\n\n`;
            
            message += 'Detail Jawaban:\n';
            appData.santriData.answers.forEach((answer, index) => {
                message += `${index + 1}. Pertanyaan ${index + 1} - `;
                message += `${answer.isCorrect ? 'Benar' : 'Salah'} (${answer.points} poin)\n`;
            });
            
            alert(message);
        }

        // Load quiz results dashboard
        function loadQuizResultsDashboard() {
            // MUAT DATA SEBELUM MENAMPILKAN
            loadData();

            // Clear containers
            recentResultsContainer.innerHTML = '';
            allResultsContainer.innerHTML = '';
            topPerformersContainer.innerHTML = '';
            
            // Display recent results
            if (appData.quizResults.length > 0) {
                const recentResults = appData.quizResults.slice(0, 3); // Get 3 most recent
                recentResults.forEach(result => {
                    recentResultsContainer.appendChild(createResultCardElement(result));
                });
            } else {
                recentResultsContainer.innerHTML = createEmptyState('Belum ada hasil kuis', 'fas fa-chart-bar');
            }
            
            // Display all results
            if (appData.quizResults.length > 0) {
                appData.quizResults.forEach(result => {
                    allResultsContainer.appendChild(createResultCardElement(result));
                });
            } else {
                allResultsContainer.innerHTML = createEmptyState('Belum ada hasil kuis', 'fas fa-chart-bar');
            }
            
            // Display top performers
            const topPerformers = getTopPerformers();
            if (topPerformers.length > 0) {
                topPerformers.forEach((player, index) => {
                    topPerformersContainer.appendChild(createTopPerformerCard(player, index + 1));
                });
            } else {
                topPerformersContainer.innerHTML = createEmptyState('Belum ada data santri terbaik', 'fas fa-trophy');
            }
        }

        // Create result card element
        function createResultCardElement(result) {
            const card = document.createElement('div');
            card.className = 'quiz-card';
            card.dataset.resultId = result.id;
            
            card.innerHTML = `
                <div class="quiz-card-header">
                    <div>
                        <div class="quiz-card-title">${result.quizTitle}</div>
                        <div class="quiz-card-pin">${result.date}</div>
                    </div>
                    <span class="quiz-status finished-status">
                        Selesai
                    </span>
                </div>
                <div class="quiz-card-info">
                    <span><i class="fas fa-users"></i> ${result.participants} Peserta</span>
                    <span><i class="fas fa-star"></i> Skor Tertinggi: ${result.topScore}</span>
                    <span><i class="fas fa-chart-line"></i> Rata-rata: ${result.averageScore}</span>
                </div>
                <div class="quiz-card-actions">
                    <button class="action-btn action-btn-primary" data-result-id="${result.id}" data-action="view">
                        <i class="fas fa-eye"></i> Lihat Detail
                    </button>
                    <button class="action-btn action-btn-outline" data-result-id="${result.id}" data-action="export">
                        <i class="fas fa-download"></i> Ekspor PDF
                    </button>
                </div>
            `;
            
            // Add event listeners to buttons
            const buttons = card.querySelectorAll('.action-btn');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    const resultId = parseInt(this.dataset.resultId);
                    const action = this.dataset.action;
                    handleResultAction(resultId, action);
                });
            });
            
            return card;
        }

        // Create top performer card
        function createTopPerformerCard(player, rank) {
            const card = document.createElement('div');
            card.className = 'quiz-card';
            
            let rankClass = '';
            if (rank === 1) rankClass = 'rank-1-badge';
            else if (rank === 2) rankClass = 'rank-2-badge';
            else if (rank === 3) rankClass = 'rank-3-badge';
            
            card.innerHTML = `
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div class="rank-badge ${rankClass}">${rank}</div>
                    <div>
                        <div class="quiz-card-title">${player.name}</div>
                        <div class="quiz-card-info">
                            <span><i class="fas fa-trophy"></i> ${player.wins} Kemenangan</span>
                            <span><i class="fas fa-star"></i> Skor Tertinggi: ${player.highestScore}</span>
                            <span><i class="fas fa-chart-line"></i> Rata-rata: ${player.averageScore}</span>
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        // Get top performers from results
        function getTopPerformers() {
            const playerStats = {};
            
            // Calculate stats for each player
            appData.quizResults.forEach(result => {
                result.players.forEach(player => {
                    if (!playerStats[player.name]) {
                        playerStats[player.name] = {
                            name: player.name,
                            wins: 0,
                            totalScore: 0,
                            quizCount: 0,
                            highestScore: 0
                        };
                    }
                    
                    playerStats[player.name].totalScore += player.score;
                    playerStats[player.name].quizCount += 1;
                    
                    if (player.rank === 1) {
                        playerStats[player.name].wins += 1;
                    }
                    
                    if (player.score > playerStats[player.name].highestScore) {
                        playerStats[player.name].highestScore = player.score;
                    }
                });
            });
            
            // Calculate averages and create array
            const performers = Object.values(playerStats).map(player => ({
                ...player,
                averageScore: Math.round(player.totalScore / player.quizCount)
            }));
            
            // Sort by average score (descending)
            return performers.sort((a, b) => b.averageScore - a.averageScore).slice(0, 5);
        }

        // Handle result actions
        function handleResultAction(resultId, action) {
            const result = appData.quizResults.find(r => r.id === resultId);
            
            if (!result) return;
            
            switch(action) {
                case 'view':
                    showDetailResults(result);
                    break;
                    
                case 'export':
                    exportToPDF(result);
                    break;
            }
        }

        // Fungsi untuk mengekspor hasil ke PDF
        function exportToPDF(result) {
            try {
                // Buat PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Judul
                doc.setFontSize(20);
                doc.setTextColor(10, 61, 98); // Warna #0a3d62
                doc.text('Hasil Kuis PP Al Aziziyyah', 105, 15, null, null, 'center');
                
                // Info Kuis
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Judul Kuis: ${result.quizTitle}`, 20, 30);
                doc.text(`Tanggal: ${result.date}`, 20, 40);
                doc.text(`Jumlah Peserta: ${result.participants}`, 20, 50);
                
                // Statistik
                doc.setFontSize(14);
                doc.setTextColor(10, 61, 98);
                doc.text('Statistik Kuis', 20, 65);
                
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Skor Tertinggi: ${result.topScore}`, 20, 75);
                doc.text(`Rata-rata Skor: ${result.averageScore}`, 20, 85);
                
                // Pemenang
                doc.setFontSize(14);
                doc.setTextColor(10, 61, 98);
                doc.text('Juara Kuis', 20, 100);
                
                doc.setFontSize(16);
                doc.setTextColor(255, 204, 0); // Warna emas
                doc.text(result.players[0] ? result.players[0].name : 'N/A', 20, 110);
                
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Skor: ${result.players[0] ? result.players[0].score : 0} poin`, 20, 120);
                
                // Tabel Peringkat
                doc.setFontSize(14);
                doc.setTextColor(10, 61, 98);
                doc.text('Peringkat Santri', 20, 135);
                
                // Header tabel
                doc.setFillColor(240, 248, 255); // Warna biru muda
                doc.rect(20, 140, 170, 10, 'F');
                doc.setTextColor(10, 61, 98);
                doc.setFontSize(11);
                doc.text('Peringkat', 25, 147);
                doc.text('Nama Santri', 60, 147);
                doc.text('Skor', 140, 147);
                doc.text('%', 165, 147);
                
                // Data tabel
                let yPos = 155;
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                
                result.players.forEach((player, index) => {
                    // Warna baris
                    if (index % 2 === 0) {
                        doc.setFillColor(248, 251, 255);
                        doc.rect(20, yPos - 5, 170, 7, 'F');
                    }
                    
                    doc.text(`${player.rank}`, 25, yPos);
                    doc.text(player.name, 60, yPos);
                    doc.text(player.score.toString(), 140, yPos);
                    
                    // Hitung persentase
                    const percentage = result.topScore > 0 ? Math.round((player.score / result.topScore) * 100) : 0;
                    doc.text(`${percentage}%`, 165, yPos);
                    
                    yPos += 7;
                    
                    // Jika halaman hampir penuh, tambah halaman baru
                    if (yPos > 280) {
                        doc.addPage();
                        yPos = 20;
                    }
                });
                
                // Footer
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text(`Dibuat oleh Quiz PP Al Aziziyyah - ${new Date().toLocaleDateString('id-ID')}`, 105, 290, null, null, 'center');
                
                // Simpan PDF
                doc.save(`Hasil_Kuis_${result.quizTitle.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`);
                
                showNotification(`Hasil kuis "${result.quizTitle}" berhasil diekspor ke PDF!`, 'success');
            } catch (error) {
                console.error('Error exporting to PDF:', error);
                showNotification('Gagal mengekspor ke PDF. Silakan coba lagi.', 'error');
            }
        }

        // Show detail results
        function showDetailResults(result) {
            detailResultsContent.innerHTML = `
                <h2 class="screen-title">Detail Hasil Kuis</h2>
                
                <div class="quiz-results-header">
                    <div>
                        <h3 style="color: #0a3d62; margin-bottom: 10px;">${result.quizTitle}</h3>
                        <p style="color: #666;">Tanggal: ${result.date} | ${result.participants} Peserta</p>
                    </div>
                    <div class="quiz-results-info">
                        <div class="result-stat">
                            <div class="result-stat-value">${result.topScore}</div>
                            <div class="result-stat-label">Skor Tertinggi</div>
                        </div>
                        <div class="result-stat">
                            <div class="result-stat-value">${result.averageScore}</div>
                            <div class="result-stat-label">Rata-rata</div>
                        </div>
                    </div>
                </div>
                
                ${result.players.length > 0 ? `
                <div class="winner">
                    <h2>Juara Kuis</h2>
                    <div class="winner-name">${result.players[0].name}</div>
                    <p style="font-size: 1.5rem; margin-top: 10px; position: relative; z-index: 1;">Skor: ${result.players[0].score} poin</p>
                </div>
                
                <div class="results-table-container">
                    <h3 style="color: #0a3d62; margin-bottom: 20px;">Peringkat Santri</h3>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Peringkat</th>
                                <th>Nama Santri</th>
                                <th>Skor</th>
                                <th>Persentase</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${result.players.map(player => `
                                <tr>
                                    <td>
                                        <div class="rank-badge ${player.rank <= 3 ? `rank-${player.rank}-badge` : ''}">
                                            ${player.rank}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="player-cell">
                                            <i class="fas fa-user-graduate"></i>
                                            <span>${player.name}</span>
                                        </div>
                                    </td>
                                    <td class="score-cell">${player.score}</td>
                                    <td class="percentage-cell">${result.topScore > 0 ? Math.round((player.score / result.topScore) * 100) : 0}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : `
                <div class="empty-state">
                    <i class="fas fa-exclamation-circle"></i>
                    <h3>Tidak Ada Data Peserta</h3>
                    <p>Hasil kuis ini tidak memiliki data peserta.</p>
                </div>
                `}
            `;
            
            switchScreen('detailResults');
        }

        // Create empty state
        function createEmptyState(message, icon) {
            return `
                <div class="empty-state">
                    <i class="fas ${icon}"></i>
                    <h3>${message}</h3>
                    <p>Silakan buat kuis pertama Anda untuk mulai menggunakan fitur ini.</p>
                </div>
            `;
        }

        // Save quiz results
        function saveQuizResults() {
            if (!appData.currentQuiz) return;
            
            const activeQuiz = appData.activeQuizzes[appData.currentQuiz.pin];
            if (!activeQuiz) return;
            
            // Sort players by score
            const sortedPlayers = [...activeQuiz.players].sort((a, b) => b.score - a.score);
            
            // Calculate statistics
            const totalScore = sortedPlayers.reduce((sum, player) => sum + player.score, 0);
            const averageScore = sortedPlayers.length > 0 ? Math.round(totalScore / sortedPlayers.length) : 0;
            const topScore = sortedPlayers.length > 0 ? sortedPlayers[0]?.score : 0;
            
            // Create result object
            const result = {
                id: appData.quizResults.length + 1,
                quizId: appData.currentQuiz.id,
                quizTitle: appData.currentQuiz.title,
                date: new Date().toLocaleString('id-ID'),
                participants: sortedPlayers.length,
                topScore: topScore,
                averageScore: averageScore,
                players: sortedPlayers.map((player, index) => ({
                    name: player.name,
                    score: player.score,
                    rank: index + 1
                }))
            };
            
            // Save to results
            appData.quizResults.unshift(result);
            
            // Hapus dari active quizzes
            delete appData.activeQuizzes[appData.currentQuiz.pin];
            appData.currentQuiz = null;

            // SIMPAN DATA KE LOCAL STORAGE
            saveData();
            
            showNotification('Hasil kuis berhasil disimpan!', 'success');
            
            // Go back to dashboard
            switchScreen('ustadzDashboard');
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>